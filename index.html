<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Subtraction Tool</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="header-container">
            <h1>حملة صلوات لروح الشهيد علي جعفر شحيمي (موسى)</h1>
        </div>
    </header>

    <div class="container">
        <h2>عدد الصلوات المطلوبة: <span id="totalNumber">1,000,000</span></h2>

        <!-- Input and Subtract button -->
        <div class="input-container">
            <input type="number" id="subtractNumber" placeholder="عدد الصلوات التي ترغب بالمشاركة بها">
            <button onclick="subtractNumber()">حفظ</button>
        </div>

        <br>
        <h2>عدد الصلوات المتبقية: <span id="remainingNumber">1,000,000</span></h2>
        <button onclick="resetNumber()">Reset</button>
    </div>

    <script>
        const initialTotal = 1000000;
        const resetPassword = "mojtaba"; // Set your own password here
        const apiUrl = "https://script.google.com/macros/s/AKfycbxeC_-1WGyOKrPFyE6uVli639U38Vdo7HvUfzauIedCUuOmeZ_CPKRXJdZO6nPxBr6V/exec"; // Replace with your Google Apps Script URL

        // Function to format the number with commas
        function formatNumberWithCommas(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Fetch the current remaining number from Google Apps Script
        function fetchTotal() {
            fetch(apiUrl)
                .then(response => response.text())
                .then(data => {
                    let remainingNumber = parseInt(data, 10);
                    if (isNaN(remainingNumber)) {
                        remainingNumber = initialTotal;
                    }
                    updateRemainingNumber(remainingNumber);
                })
                .catch(error => {
                    console.error("Error fetching total:", error);
                });
        }

        // Subtract number and update in Google Sheets
        function subtractNumber() {
    const subtractValue = parseInt(document.getElementById('subtractNumber').value, 10);
    
    // Validate input
    if (isNaN(subtractValue) || subtractValue <= 0) {
        alert("Please enter a valid number greater than 0.");
        return;
    }

    // Update local value
    remainingNumber -= subtractValue;

    // Prevent going below 0
    if (remainingNumber < 0) {
        remainingNumber = 0;
    }

    // Save to localStorage
    localStorage.setItem('remainingNumber', remainingNumber);

    // If you are calling an external API (like Google Sheets or Firebase), ensure the API is working
    fetchAPIToSaveData(remainingNumber); // Example API call
}

async function fetchAPIToSaveData(remainingNumber) {
    try {
        // Example of making an API call to update Google Sheets or Firebase
        const response = await fetch('YOUR_API_URL', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ remainingNumber: remainingNumber }),
        });

        const result = await response.json();
        console.log("Data saved successfully:", result);
    } catch (error) {
        console.error("Error saving data:", error);
    }
}


        // Function to handle reset
        function resetNumber() {
            const userPassword = prompt("Enter the password to reset:");
            if (userPassword === resetPassword) {
                fetch(apiUrl + "?remainingNumber=" + initialTotal, { method: "POST" })
                    .then(response => response.text())
                    .then(() => {
                        updateRemainingNumber(initialTotal);
                        alert("Remaining number has been reset!");
                    })
                    .catch(error => {
                        console.error("Error resetting number:", error);
                    });
            } else {
                alert("Incorrect password! Reset denied.");
            }
        }

        // Update the displayed remaining number
        function updateRemainingNumber(number) {
            const formattedRemaining = formatNumberWithCommas(number);
            document.getElementById('remainingNumber').textContent = formattedRemaining;
        }

        // Fetch total number on page load
        fetchTotal();
    </script>
</body>
</html>
